(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["pages-index-index"],{"14f0":function(e,t,n){"use strict";n.d(t,"b",(function(){return s})),n.d(t,"c",(function(){return o})),n.d(t,"a",(function(){return i}));var i={uniList:n("89e1").default,uniListItem:n("37a9").default},s=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("v-uni-view",{staticClass:"content"},[n("uni-list",e._l(e.visitors,(function(t){return n("uni-list-item",{key:t.visitor_id,attrs:{title:t.username,note:t.last_message,thumb:e.baseUrl+t.avator,"thumb-size":"lg",clickable:!0},on:{click:function(n){arguments[0]=n=e.$handleEvent(n),e.chatVisitor(n,t.visitor_id)}}})})),1),n("v-uni-view",{directives:[{name:"show",rawName:"v-show",value:0==e.visitors.length,expression:"visitors.length==0"}],staticClass:"flyNotice"},[e._v("暂无在线访客")]),n("v-uni-view",{directives:[{name:"show",rawName:"v-show",value:e.noticeContent,expression:"noticeContent"}],staticClass:"flyNoticeBar"},[e._v(e._s(e.noticeContent))])],1)},o=[]},"5fc5":function(e,t,n){"use strict";n.r(t);var i=n("feb3"),s=n.n(i);for(var o in i)"default"!==o&&function(e){n.d(t,e,(function(){return i[e]}))}(o);t["default"]=s.a},"8dfe":function(e,t,n){"use strict";n.r(t);var i=n("14f0"),s=n("5fc5");for(var o in s)"default"!==o&&function(e){n.d(t,e,(function(){return s[e]}))}(o);var a,r=n("f0c5"),c=Object(r["a"])(s["default"],i["b"],i["c"],!1,null,"344d5bf3",null,!1,i["a"],a);t["default"]=c.exports},feb3:function(e,t,n){"use strict";n("a434"),Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i={data:function(){return{title:"Hello",baseUrl:getApp().globalData.baseUrl,wsBaseUrl:getApp().globalData.wsBaseUrl,visitors:[],token:"",timer:null,wsOpen:!1,noticeContent:""}},onShow:function(){var e=uni.getStorageSync("app");console.log(e),e&&(this.token=e.token),this.checkAuth(),this.getOnlineUser()},onLoad:function(){this.initPush()},methods:{onlineIntime:function(){var e=this,t=null;uni.connectSocket({url:this.wsBaseUrl+"?token="+this.token}),uni.onSocketClose((function(e){clearInterval(t),console.log("WebSocket 连接断开")})),uni.onSocketOpen((function(e){console.log("WebSocket 连接已打开");var n={type:"ping",data:""};t=setInterval((function(){uni.sendSocketMessage({data:JSON.stringify(n)})}),5e3)})),uni.onSocketMessage((function(t){var n=JSON.parse(t.data);switch(n.type){case"allUsers":break;case"userOnline":e.addOnlineUser(n.data);break;case"userOffline":e.removeOfflineUser(n.data);break;case"notice":break;case"message":e.recvMessage(n.data);break}}))},getOnlineUser:function(){var e=this,t=this.baseUrl;uni.request({url:t+"/visitors_kefu_online?token="+e.token,method:"GET",success:function(t){console.log(t),t.data.result&&(e.visitors=t.data.result)},fail:function(e){}})},addOnlineUser:function(e){for(var t=this.visitors,n=!1,i=0;i<t.length;i++)t[i].uid==e.uid&&(n=!0);n||t.unshift(e),this.visitors=t,this.showNoticeBar(e.username+"来了")},removeOfflineUser:function(e){for(var t=this.visitors,n=0;n<t.length;n++)t[n].uid==e.uid&&t.splice(n,1);this.visitors=t,this.showNoticeBar(e.name+"离线")},chatVisitor:function(e,t){uni.navigateTo({url:"/pages/index/detail?visitor_id="+t})},recvMessage:function(e){for(var t=this.visitors,n=0;n<t.length;n++)t[n].uid==e.id&&(t[n].last_message=e.content);this.visitors=t,this.showNotice(e.name+":"+e.content)},initPush:function(){},showNotice:function(e){},showNoticeBar:function(e){var t=this;t.noticeContent=e,setTimeout((function(){t.noticeContent=""}),3e3)},checkAuth:function(){var e=this;uni.request({url:e.baseUrl+"/userinfo?token="+e.token,method:"GET",success:function(t){var n=t.data.code;200!=n?uni.navigateTo({url:"/pages/index/login"}):e.onlineIntime()}})},registerClient:function(e){var t=this,n=this.baseUrl;uni.request({url:n+"/kefuinfo_client?token="+t.token,data:{client_id:e},method:"POST",header:{"Content-Type":"application/x-www-form-urlencoded"},success:function(e){console.log(e)}})}}};t.default=i}}]);