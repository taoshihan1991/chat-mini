(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["pages-index-history"],{"1e90":function(e,t,n){"use strict";n.r(t);var i=n("6075"),o=n.n(i);for(var s in i)"default"!==s&&function(e){n.d(t,e,(function(){return i[e]}))}(s);t["default"]=o.a},6075:function(module,exports,__webpack_require__){"use strict";__webpack_require__("99af"),__webpack_require__("fb6a"),__webpack_require__("d3b7"),__webpack_require__("ac1f"),__webpack_require__("25f0"),__webpack_require__("5319"),Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _default={data:function(){return{title:"Hello",baseUrl:getApp().globalData.baseUrl,wsBaseUrl:getApp().globalData.wsBaseUrl,visitors:[],token:"",timer:null,wsOpen:!1,noticeContent:"",page:1}},onShow:function(){var e=uni.getStorageSync("app");console.log(e),e&&(this.token=e.token),this.checkAuth(),this.getOnlineUser(this.page)},onLoad:function(){},onPullDownRefresh:function(){console.log("refresh"),this.getNewOnlineUser(1),setTimeout((function(){uni.stopPullDownRefresh()}),1e3)},onReachBottom:function(){console.log("1"),this.page++,this.getOnlineUser(this.page)},methods:{onlineIntime:function(){var e=this,t=null;uni.connectSocket({url:this.wsBaseUrl+"?token="+this.token}),uni.onSocketClose((function(e){clearInterval(t),console.log("WebSocket 连接断开")})),uni.onSocketOpen((function(e){console.log("WebSocket 连接已打开");var n={type:"ping",data:""};t=setInterval((function(){uni.sendSocketMessage({data:JSON.stringify(n)})}),5e3)})),uni.onSocketMessage((function(t){var n=JSON.parse(t.data);switch(n.type){case"userOnline":e.showNoticeBar(n.data.username+"来了");break;case"userOffline":e.showNoticeBar(n.data.name+"离线");break}}))},getOnlineUser:function(e){var t=this,n=this.baseUrl;uni.request({url:n+"/visitors?page="+e+"&pagesize=14&token="+t.token,method:"GET",success:function(e){if(console.log(e),e.data.result.list){var n=e.data.result.list;0==t.visitors.length?t.visitors=n:t.visitors=t.visitors.concat(t.visitors,n),t.visitors=t.removeRepeat(t.visitors)}},fail:function(e){}})},getNewOnlineUser:function(e){var t=this,n=this.baseUrl;uni.request({url:n+"/visitors?page="+e+"&pagesize=14&token="+t.token,method:"GET",success:function(e){if(e.data.result.list){var n=e.data.result.list;t.visitors=n}}})},chatVisitor:function(e,t){uni.navigateTo({url:"/pages/index/detail?visitor_id="+t})},showNoticeBar:function(e){var t=this;t.noticeContent=e,setTimeout((function(){t.noticeContent=""}),3e3)},checkAuth:function(){var e=this;uni.request({url:e.baseUrl+"/userinfo?token="+e.token,method:"GET",success:function(t){var n=t.data.code;200!=n?uni.navigateTo({url:"/pages/index/login"}):e.onlineIntime()}})},removeRepeat:function(e){for(var t,n=0,i=e.length,o={},s=[];n<i;n++)t=e[n].id,t=typeof t+t,o[t]||(o[t]=1,s.push(e[n]));return s},formatTime:function formatTime(time,fmt){if(null!=time){var fmt=fmt||"yyyy-MM-dd hh:mm:ss",time=new Date(time),z={M:time.getMonth()+1,d:time.getDate(),h:time.getHours(),m:time.getMinutes(),s:time.getSeconds()};return fmt=fmt.replace(/(M+|d+|h+|m+|s+)/g,(function(v){return((v.length>1?"0":"")+eval("z."+v.slice(-1))).slice(-2)})),fmt.replace(/(y+)/g,(function(e){return time.getFullYear().toString().slice(-e.length)}))}}}};exports.default=_default},"816c":function(e,t,n){"use strict";n.r(t);var i=n("9004"),o=n("1e90");for(var s in o)"default"!==s&&function(e){n.d(t,e,(function(){return o[e]}))}(s);var a,r=n("f0c5"),u=Object(r["a"])(o["default"],i["b"],i["c"],!1,null,"60cbc880",null,!1,i["a"],a);t["default"]=u.exports},9004:function(e,t,n){"use strict";n.d(t,"b",(function(){return o})),n.d(t,"c",(function(){return s})),n.d(t,"a",(function(){return i}));var i={uniList:n("a2a1").default,uniListItem:n("3e4a").default},o=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("v-uni-view",{staticClass:"content"},[n("uni-list",e._l(e.visitors,(function(t){return n("uni-list-item",{key:t.id,attrs:{note:"最近:"+e.formatTime(t.updated_at)+"\n首访:"+e.formatTime(t.created_at),title:t.id+"|"+t.name,thumb:e.baseUrl+t.avator,"thumb-size":"lg",clickable:!0},on:{click:function(n){arguments[0]=n=e.$handleEvent(n),e.chatVisitor(n,t.visitor_id)}}})})),1),n("v-uni-view",{directives:[{name:"show",rawName:"v-show",value:0==e.visitors.length,expression:"visitors.length==0"}],staticClass:"flyNotice"},[e._v("暂无数据")]),n("v-uni-view",{directives:[{name:"show",rawName:"v-show",value:e.noticeContent,expression:"noticeContent"}],staticClass:"flyNoticeBar"},[e._v(e._s(e.noticeContent))])],1)},s=[]}}]);